name: Promote to production

on:
  workflow_dispatch: {}

concurrency:
  group: promote-to-production
  cancel-in-progress: true

jobs:
  preprod-tests:
    if: github.ref == 'refs/heads/master'
    uses: ./.github/workflows/preprod-tests.yml
    with:
      python-version: '3.13'
    secrets: inherit

  open-pull-request:
    if: github.ref == 'refs/heads/master'
    needs: preprod-tests
    runs-on: ubuntu-latest
    permissions:
      contents: write        # need write to read/compare/create PR metadata
      pull-requests: write
      actions: read
    steps:
      - name: Diff master vs production
        id: diff
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}   # <-- no secret needed
          script: |
            const { owner, repo } = context.repo;
            const base = 'production';
            const head = 'master';
            const cmp = await github.rest.repos.compareCommits({ owner, repo, base, head });
            const skip = cmp.data.ahead_by === 0 ? 'true' : 'false';
            core.setOutput('skip', skip);
            core.notice(skip === 'true'
              ? 'No differences between master and production.'
              : `Diff found: master is ahead by ${cmp.data.ahead_by} commit(s).`);

      - name: Create or find PR master → production
        if: steps.diff.outputs.skip != 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}   # <-- no secret needed
          script: |
            const { owner, repo } = context.repo;
            const base = 'production';
            const head = 'master';

            try {
              const listResp = await github.rest.pulls.list({
                owner, repo, state: 'open', base, head: `${owner}:${head}`
              });
              if (listResp.data.length > 0) {
                const pr = listResp.data[0];
                core.notice(`PR already open: #${pr.number}`);
                core.setOutput('pr_number', pr.number.toString());
                return;
              }

              const createResp = await github.rest.pulls.create({
                owner, repo,
                title: `Promote ${head} → ${base}`,
                head, base,
                body: 'Manual promotion. Review the changes and merge after checks are green.'
              });
              core.notice(`Created PR #${createResp.data.number}`);
              core.setOutput('pr_number', createResp.data.number.toString());
            } catch (e) {
              if (e.status === 403) {
                core.setFailed(
                  "403: Creating PRs with GITHUB_TOKEN is blocked by repo/org settings. " +
                  "Either enable 'Allow GitHub Actions to create and approve pull requests' " +
                  "or switch to the PAT-based workflow."
                );
                return;
              }
              throw e;
            }
