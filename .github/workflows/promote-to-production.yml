name: Promote to production

on:
  workflow_dispatch: {}

concurrency:
  group: promote-to-production
  cancel-in-progress: true

jobs:
  preprod-tests:
    uses: ./.github/workflows/preprod-tests.yml
    with:
      python-version: '3.13'
    secrets: inherit

  open-pull-request:
    needs: preprod-tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Skip if no diff between master and production
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.MACHINE_USER_TOKEN }} # PAT of machine user
          script: |
            const { owner, repo } = context.repo;
            const base = 'production';
            const head = 'master';
            const cmp = await github.rest.repos.compareCommits({
              owner, repo, base, head
            });
            if (cmp.data.ahead_by === 0) {
              core.notice('No differences between master and production. Nothing to promote.');
              core.setOutput('skip', 'true');
            } else {
              core.notice(`Diff found: master is ahead by ${cmp.data.ahead_by} commit(s).`);
              core.setOutput('skip', 'false');
            }

      - name: Create or find PR master → production
        if: steps.skip-if-no-diff.outputs.skip != 'true'
        id: create_pr
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.MACHINE_USER_TOKEN }} # PAT of machine user
          script: |
            const { owner, repo } = context.repo;
            const base = 'production';
            const head = 'master';

            // Check if an open PR already exists
            const listResp = await github.rest.pulls.list({
              owner, repo, state: 'open', base, head: `${owner}:${head}`
            });
            if (listResp.data.length > 0) {
              const pr = listResp.data[0];
              core.notice(`PR already open: #${pr.number}`);
              core.setOutput('pr_number', pr.number.toString());
              return;
            }

            // Create a new PR
            const createResp = await github.rest.pulls.create({
              owner, repo,
              title: `Promote ${head} → ${base}`,
              head, base,
              body: 'Manual promotion. Review the changes and merge after checks are green.'
            });
            core.notice(`Created PR #${createResp.data.number}`);
            core.setOutput('pr_number', createResp.data.number.toString());
